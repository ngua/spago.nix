#+title: ~spago.nix~
#+export_file_name: ../README.org

üçù.‚ùÑ

* Table of Contents :toc:
- [[#introduction][Introduction]]
  - [[#stability][Stability]]
- [[#quick-start][Quick Start]]
- [[#motivation][Motivation]]
- [[#documentation][Documentation]]
- [[#caveats][Caveats]]
- [[#acknowledgments][Acknowledgments]]

* Introduction
~spago.nix~ is tool that aims to provide ergonomic Nix integration for Purescript projects built with [[https:github.com/purescript/spago][Spago]]. It aims to supersede tools such as [[https:github.com/justinwoo/spago2nix][ ~spago2nix~ ]] and provide the following features:

- *Zero* autogenerated Nix code for users (but see the [[#caveats][caveats]] below)
- A flakes-first workflow
- Support for easily generating flakes outputs from Spago projects

See the [[#motivation][Motivation]] below for more information on why ~spago.nix~ was created.

** Stability
~spago.nix~ is currently fairly experimental -- things may not work correctly for your project and there are almost certainly many edge cases still lurking within. If you find that's the case, please open an issue and I'll do my best to try to fix it!

* Quick Start
1. Add ~github:ngua/spago-nix~ to your flake input
2. Add ~inputs.spago-nix.overlays.default~ to your ~overlays~ where you import ~nixpkgs~
3. Initialize a project with ~pkgs.spago-nix.spagoProject~. The only two required arguments to this function are ~src~ and ~name~ (see the [[#documentation][documentation]] for more)
4. *Optional*: If your Spago project depends on any third-party dependencies (i.e. /not/ in an upstream package set), add them to your flake inputs and include them in the ~extraSources~ argument to ~spagoProject~
5. ~spagoProject~ returns a ~flake~ attribute with some default ~packages~, ~apps~, and ~devShells~, along with functions for creating more outputs (see the [[#documentation][documentation]] for more details)

*Example*:

#+INCLUDE: "../example/flake.nix" src nix

* Motivation
The status quo for building Purescript projects with Nix is unfortunately quite lackluster. Neither Spago nor its chosen configuration language, Dhall, are particularly amenable to working in pure environments such as the Nix build sandbox. Spago's package format does not include the hashes for declared dependencies, meaning that these must be calculated somehow before fetching the sources for each dependency.

The current default choice for Purescript users wanting to build with Nix is ~spago2nix~, which is affected by these limitations. ~spago2nix~ approaches the lack of hashes by calling ~nix-prefetch-git~ for each dependency (as does ~spago.nix~, but in a different step that does not directly affect users). This also prevents ~spago2nix~ from being run in a pure environment, however. This could be worked around by using fixed-output derivations with ~spago2nix~, but that would lead to an unpleasant interface.

Because of this fundamental limitation, ~spago2nix~ requires generating and committing Nix code (its ~spago-packages.nix~). Obscure build errors can arise when users forget to run ~spago2nix generate~, which is not especially rare in my experience. ~spago2nix~ also provides a fairly limited interface that is quite far from that of ~spago~ -- if users wish to build project documentation, for example, they must write derivations by hand. Its interface for building a Spago project consists of a single derivation -- ~build-spago-style~ -- that does not allow for any control over or customization of the build process (it calls ~purs~ directly with the provided sources). ~spago2nix~ also does not use ~spago~ internally, which means that  the experience of building the same project might differ depending on the context (i.e either inside or outside of Nix).

Most of the time, a user's ~spago-packages.nix~ will primarily contain the same Purescript packages from upstream package sets. Instead of requiring the user to always generate Nix package sets containing hashes for each dependency, we can generate them and then store them centrally in a repository. This emulates package sets like ~nodePackages~ and, most importantly, allows us to create a suitable package set for users in a pure environment, thus freeing them from needing to generated Nix code. See [[file:./docs/how-it-works.org][how ~spago.nix~ works]] for more details on its approach.

* Documentation
# The paths need to be set to `./doc/...` since this will be exported to `../README.org`
- [[file:./docs/reference.org][Reference]]
- [[file:./docs/how-it-works.org][How ~spago.nix~ works]]
- [[file:./docs/faq.org][FAQ]]

* Caveats
[[file:./docs/how-it-works.org][The docs]] provide a brief overview of how ~spago.nix~ works. There are some consequences to the approach it uses, however, and ~spago.nix~ might not work with your Spago project. ~spago.nix~ is also under heavy development and some of its present limitations may be resolved in the future. In the meantime, the following major caveats apply:

- No custom package sets can be used with ~import~ statements in ~packages.dhall~ ::
  If you ~import~ a third-party Dhall package set (for example, a common set of dependencies to reduce repetition in different ~packages.dhall~ with the same dependencies), ~spago.nix~ will not work properly. The import will be extracted, but ignored. For example:
  #+begin_src dhall
  -- OK, this is an official package set and will work
  let upstream =
      https://github.com/purescript/package-sets/releases/download/psc-0.x.x/packages.dhall
          sha256:0000000000000000000000000000000000000000000000000000000000000000

  -- Will not work :(
  let special-packages =
      https://example.com/foo/bar/special-packages.dhall
          sha256:0000000000000000000000000000000000000000000000000000000000000000

  #+end_src

- Alternate backends aren't supported ::
  Currently, using alternate Purescript backends is not supported (e.g. [[github:andyarvanitis/purescript-native][purescript-native]]). This may change in the future, although these backends are generally not up-to-date with ~purs~ itself.

- Spago is going to change dramatically soon ::
  The ~spago~ tool itself is currently undergoing a rewrite from Haskell to Purescript. This will require changing a significant part of how ~spago.nix~ works. In particular, since the Spago configuration format has changed from Dhall to YAML, the vast majority, if not all, of ~spago.nix~'s Haskell component will no longer be required. ~spago~'s behavior will certainly change as well, and it will take some time before compatibility with the new version is achieved. Even after that is done, however, I plan on maintaining compatibility with legacy Spago for some time, perhaps under a ~legacySpagoProject~ namespace.

* Acknowledgments
~spago.nix~ was directly inspired by Justin Woo's previous work on [[https://github.com/justinwoo/spago2nix][spago2nix]].

* Local variables :noexport:
Local variables:
eval: (add-hook 'after-save-hook 'org-org-export-to-org nil t)
end:
